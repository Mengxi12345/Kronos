# Kronos 项目规则文件

## 项目概述

Kronos 是一个用于金融市场K线序列预测的基础模型项目。项目采用两阶段框架：
1. 专门的 tokenizer 将连续的多维K线数据（OHLCV）量化为分层离散token
2. 大型自回归 Transformer 在这些token上进行预训练

## 项目结构

```
Kronos/
├── model/              # 核心模型代码
│   ├── kronos.py      # KronosTokenizer, Kronos, KronosPredictor 主类
│   ├── module.py       # Transformer模块和BSQuantizer
│   └── __init__.py     # 模型导出
├── webui/              # Web用户界面
│   ├── app.py         # Flask应用主文件
│   ├── run.py         # 启动脚本
│   └── templates/      # HTML模板
├── finetune/          # 微调脚本（Qlib数据）
├── finetune_csv/      # 微调脚本（CSV数据）
├── examples/           # 使用示例
└── tests/              # 测试代码
```

## 核心类和API

### 主要类
- `KronosTokenizer`: 将K线数据量化为token
- `Kronos`: 主Transformer模型
- `KronosPredictor`: 预测器，封装了完整的预测流程

### 使用模式
```python
from model import Kronos, KronosTokenizer, KronosPredictor

# 1. 加载模型和tokenizer
tokenizer = KronosTokenizer.from_pretrained("NeoQuasar/Kronos-Tokenizer-base")
model = Kronos.from_pretrained("NeoQuasar/Kronos-small")

# 2. 创建预测器
predictor = KronosPredictor(model, tokenizer, device="cuda:0", max_context=512)

# 3. 准备数据（DataFrame必须包含 open, high, low, close 列）
# 4. 调用predict方法
pred_df = predictor.predict(df=x_df, x_timestamp=x_ts, y_timestamp=y_ts, pred_len=120)
```

## 代码风格和约定

### Python代码规范
- 使用Python 3.10+
- 遵循PEP 8代码风格
- 使用类型提示（如适用）
- 函数和类必须有docstring
- 使用有意义的变量名

### 导入顺序
1. 标准库导入
2. 第三方库导入（torch, pandas, numpy等）
3. 本地模块导入（使用sys.path.append添加项目根目录）

### 错误处理
- 使用try-except处理模型加载失败
- 检查数据格式和必需列
- 提供清晰的错误消息

### 数据格式要求

#### 输入DataFrame必需列
- `open`: 开盘价
- `high`: 最高价
- `low`: 最低价
- `close`: 收盘价

#### 可选列
- `volume`: 交易量
- `amount`: 交易金额（不用于预测，仅用于显示）
- `timestamps`/`timestamp`/`date`: 时间戳

#### 时间戳处理
- 支持多种时间戳列名：`timestamps`, `timestamp`, `date`
- 使用`pd.to_datetime()`转换时间戳
- 时间戳必须与数据行对应

### 模型配置

#### 可用模型
- `kronos-mini`: 4.1M参数，context_length=2048
- `kronos-small`: 24.7M参数，context_length=512
- `kronos-base`: 102.3M参数，context_length=512

#### 设备支持
- `cpu`: 通用计算
- `cuda:0`, `cuda:1`等: NVIDIA GPU
- `mps`: Apple Silicon GPU

#### 上下文长度限制
- `Kronos-small`和`Kronos-base`的`max_context`为512
- `Kronos-mini`的`max_context`为2048
- 输入数据长度不应超过这些限制，`KronosPredictor`会自动处理截断

### 预测参数

#### 温度（T）
- 范围：0.1 - 2.0
- 推荐值：1.2-1.5
- 控制预测的随机性

#### 核采样（top_p）
- 范围：0.1 - 1.0
- 推荐值：0.95-1.0
- 控制预测的多样性

#### 样本数量（sample_count）
- 范围：1 - 5
- 推荐值：2-3
- 生成多个预测样本并平均

### Web UI开发

#### Flask应用结构
- 使用Flask + Flask-CORS
- 全局变量存储模型：`tokenizer`, `model`, `predictor`
- API端点返回JSON格式
- 使用Plotly生成图表

#### API端点约定
- `/api/load-model`: 加载模型
- `/api/load-data`: 加载数据文件
- `/api/predict`: 执行预测
- `/api/data-files`: 获取可用数据文件列表

#### 前端约定
- 使用Plotly.js显示K线图
- 时间窗口固定为400+120=520个数据点
- 支持CSV和Feather格式

### 文件组织

#### 新功能开发
- 模型相关代码放在`model/`目录
- Web UI相关代码放在`webui/`目录
- 示例代码放在`examples/`目录
- 测试代码放在`tests/`目录

#### 微调脚本
- Qlib数据微调：`finetune/`目录
- CSV数据微调：`finetune_csv/`目录
- 配置文件使用YAML格式

### 依赖管理

#### 核心依赖
- torch >= 2.1.0
- pandas == 2.2.2
- numpy
- huggingface_hub == 0.33.1
- einops == 0.8.1

#### Web UI依赖
- flask == 2.3.3
- flask-cors == 4.0.0
- plotly == 5.17.0

### 最佳实践

#### 数据处理
- 始终检查DataFrame是否包含必需列
- 处理缺失的时间戳列名（timestamps/timestamp/date）
- 使用`pd.to_datetime()`标准化时间戳
- 验证数据长度是否足够（至少400+120个数据点）

#### 模型使用
- 首次加载模型可能需要从Hugging Face下载，需要网络连接
- 使用适当的设备（GPU加速推荐）
- 注意上下文长度限制
- 批量预测时确保所有序列长度一致

#### 错误处理
- 优雅处理模型加载失败（提供降级方案）
- 验证输入数据格式
- 提供清晰的错误消息给用户
- 使用warnings.filterwarnings('ignore')抑制警告

#### 性能优化
- 使用批量预测（`predict_batch`）处理多个序列
- 利用GPU并行计算
- 缓存加载的模型避免重复加载
- 使用适当的数据类型（float32 vs float64）

### 测试和验证

#### 回归测试
- 测试文件在`tests/`目录
- 使用`test_kronos_regression.py`进行回归测试
- 验证模型输出的一致性

#### 数据验证
- 检查数据格式和列名
- 验证时间戳格式
- 确保数据长度足够

### 文档和注释

#### 代码注释
- 类和函数必须有docstring
- 复杂逻辑需要行内注释
- 使用中文或英文注释（根据项目需要）

#### README文件
- 主README说明项目概述和使用方法
- webui/README说明Web UI使用方法
- 示例代码包含详细注释

### 版本兼容性

#### Python版本
- 要求Python 3.10+
- 测试Python 3.10, 3.11, 3.12, 3.13

#### PyTorch版本
- 要求torch >= 2.1.0
- 支持CUDA和MPS后端

### 安全注意事项

#### 文件上传（Web UI）
- 验证文件格式（仅允许CSV和Feather）
- 限制文件大小
- 检查文件路径防止路径遍历攻击

#### 模型加载
- 验证模型ID来自可信源（Hugging Face）
- 检查模型文件完整性

### 常见问题和解决方案

#### 端口占用
- Web UI默认端口7070
- 可在app.py中修改端口号

#### 模型加载失败
- 检查网络连接
- 验证Hugging Face模型ID
- 检查磁盘空间

#### 数据格式错误
- 确保包含必需列：open, high, low, close
- 检查时间戳格式
- 验证数据长度

## 开发工作流

### 添加新功能
1. 在相应目录创建或修改文件
2. 遵循现有代码风格
3. 添加适当的文档和注释
4. 更新README（如需要）
5. 测试新功能

### 修改模型
1. 修改`model/kronos.py`或`model/module.py`
2. 更新`model/__init__.py`（如需要）
3. 运行回归测试确保兼容性
4. 更新文档

### 修改Web UI
1. 修改`webui/app.py`添加新API端点
2. 更新`webui/templates/index.html`（如需要）
3. 测试前端功能
4. 更新`webui/README.md`（如需要）

## 注意事项

- `amount`列不用于预测，仅用于显示
- 时间窗口固定为400+120=520个数据点
- 首次模型加载需要网络连接下载模型
- 确保数据文件包含足够的历史数据
- 批量预测时所有序列必须具有相同的历史长度和预测长度

